name: API-Deploye

on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - dev

jobs:
    build-and-deploy:
        runs-on: self-hosted

        steps:
            - name: Checkout Repository
              uses: actions/checkout@v2

            - name: Stop and Remove Existing Containers and Volumes
              working-directory: MapAction
              run: |
                  docker-compose -f _cd_pipeline.yml down -v --remove-orphans

            - name: Build and Run Docker Compose
              working-directory: MapAction
              run: |
                  docker-compose -f _cd_pipeline.yml up --build -d

            - name: Wait for Database to be Ready
              run: |
                  docker-compose -f _cd_pipeline.yml exec postgres-db sh -c '
                    until pg_isready -U your_user; do
                      echo "Waiting for PostgreSQL..."
                      sleep 2
                    done
                  '

            - name: Run Django Migrations
              run: |
                  docker-compose -f _cd_pipeline.yml exec api-server python manage.py migrate

            - name: Cleanup Docker (Optional but Recommended)
              if: always()
              run: |
                  docker system prune -f
                  docker volume prune -f
